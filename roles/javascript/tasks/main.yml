---
# tasks file for roles/javascript

- name: check if nvm is installed
  stat:
    path: '{{ ansible_env.HOME }}/.nvm/nvm.sh'
  register: nvm

- name: install nvm
  shell: curl -o- https://raw.githubusercontent.com/creationix/nvm/master/install.sh | bash
  when: not nvm.stat.exists

# TODO: --lts=carbon/boron
- name: install node
  shell: '. {{ ansible_env.HOME }}/.nvm/nvm.sh && nvm install {{ item }}'
  with_items: [ '{{ node_install_list }}' ]

# TODO: set default

- name: get the path of default node
  shell: '. {{ ansible_env.HOME }}/.nvm/nvm.sh && nvm use --silent --lts && which node'
  changed_when: false
  register: nodes_info

# - set_fact:
#   vars:
#     exec_list:
#   args:
#     exec_list: '{{ exec_list }} [bb]'
#   with_items: [ '{{ nodes_info.results }}' ]
#
# - debug:
#     msg: '{{ exec_list }}'

- name: 'install JavaScript utilities: {{ util_install_list }}'
  vars:
    bin_dir: '{{ nodes_info.stdout | dirname }}'
  npm:
    name: '{{ item }}'
    global: yes
    state: present
    # registry: https://registry.npm.taobao.org
    executable: '{{ bin_dir }}/npm'
  environment:
    NVM_DIR: '{{ ansible_env.HOME }}/.nvm'
    PATH: '{{ bin_dirÂ }}:{{ ansible_env.PATH }}'
  with_items: '{{ util_install_list }}'
